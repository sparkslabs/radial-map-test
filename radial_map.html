<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Radial Map POC</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #ffffff;
    color: #ddd;
    display: flex;
    flex-direction: column;
    align-items: centre;
  }

  #layout {
    display: grid;
    grid-template-columns: max-content auto;
    gap: 36px;
    max-width: 1400px;
    margin: 20px 24px;
    align-items: start;

    color: #000;
  }

  #info {
    color: #000;
  }

  #info h1 {
    margin-top: 0;
    font-size: 28px;
  }

  #info p {
    line-height: 1.5;
  }

  header {
    padding: 10px 16px;
    background: #2b2b33;
    width: 100%;
    box-sizing: border-box;
  }

  #container {
    max-width: 100%;
    aspect-ratio: 10/9;
    height: min(90vh, 900px);
    width: auto;
    margin: 20px auto;
  /* border: 1px solid #444; */ /* For handy debugging... */
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), #ffffff 60%);
  }

  svg {
    width: 100%;
    height: 100%;
    display: block;
    filter:
         drop-shadow(0px 0px 10px rgba(0,0,0,0.18))
         drop-shadow(0px 0px 30px rgba(0,0,0,0.2));
  }

  .cell {
    stroke: #ffffff;
    stroke-width: 1.5;
  }

  .cell:hover {
    filter: brightness(1.15);
  }

  .dot {
    fill: #ffcc66;
    stroke: #222;
    stroke-width: 1;
  }

  .dot-label {
    fill: #000;
    font-size: 13px;
    text-anchor: left;
    pointer-events: none;
  }

  .ring-label {
    fill: #000;
    font-size: 16px;
    font-weight: 600;
  }

  .segment-label {
    fill: #000;
    font-size: 16px;
    font-weight: 600;
  }
  /*   Prevent rim stealing events */
  .rim { pointer-events:none; }

@media (max-width: 1000px) {
  #layout {
    grid-template-columns: 1fr;
  }

  #info {
    max-width: 70ch;
  }
}

/* expanded / focus mode */
/* focus mode */
body.map-expanded #layout {
  grid-template-columns: 1fr;
}

body.map-expanded #info {
  display: none;
}

/* make the svg own the viewport width */
body.map-expanded #container {
  position: relative;

  width: 100vw;
  height: auto;
  max-width: none;
 
  margin-left: calc(50% - 50vw);   /* escape parent width */
}

/* remove height constraint */
body.map-expanded #container svg {
  height: auto;
  width: 100%;
}
.hint-label {
  font-size: 18px;
  font-weight: 600;
  fill: #444;
  opacity: 0.7;
  pointer-events: none;
  user-select: none;
  font-style: italic;
}
svg:hover .hint-label {
  opacity: 1;
}
</style>
</head>

<body>

<header>
  <strong>Radial Map â€” version 0</strong>
</header>

<div id="layout">
  <div id="container"></div>

  <aside id="info">
    <h1>Radial Map</h1>
    <p>
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
      Praesent vitae eros eget tellus tristique bibendum. 
      Donec rutrum sed sem quis venenatis. Proin viverra risus a eros volutpat tempor.
    </p>
  </aside>
</div>


<!-- <div id="container"></div> -->

<script type="module">
/* =======================
   Configuration
======================= */


const ring_labels = ["Analysis","Prototype","Infrastructure"];
const segment_labels = [ "Compatibility", "FAIRness",
                         "Flexibility", "Functional Suitability",
                         "Interaction Capability", "Maintainability",
                         "Performance Efficiency", "Reliability",
                         "Safety", "Security",
                         "Sustainability" ]



const _ITEMS = [
  { id:"a1", label:"Apple" },
  { id:"c3", label:"Banana" },
  { id:"d2", label:"Cat" },
  { id:"f1", label:"Dog" },
  { id:"b2", label:"Elephant" },
  { id:"e3", label:"Fox" },
  { id:"a3", label:"Grape" },
  { id:"c1", label:"Horse" }
];

const ITEMS = [
  { id:"a1", label:"resqui" },
  { id:"a3", label:"Docker" },
  { id:"a3", label:"Apptainer" },
  { id:"a3", label:"SingularityCE" },
  { id:"a3", label:"CMAKE" },
  { id:"b1", label:"resqui" },
  { id:"b1", label:"SQAaas" },
  { id:"b1", label:"eOSSR" },
  { id:"b1", label:"Fair-Aware tool" },
  { id:"b1", label:"Five Recommendations for FAIR Software" },
  { id:"b2", label:"REUSE" },
  { id:"b2", label:"Fair Python CookieCutter" },
  { id:"b3", label:"zenodo" },
  { id:"b3", label:"Hermes Workflows" },
  { id:"b3", label:"howfairis" },
  { id:"b3", label:"F-UJI" },
  { id:"b3", label:"DVC" },
  { id:"b3", label:"SOMEF" },
  { id:"b3", label:"cffinit" },
  { id:"b3", label:"CC-License Chooser" },
  { id:"b3", label:"Somesy" },
  { id:"b3", label:"CodeMeta Generator" },
  { id:"c1", label:"resqui" },
  { id:"c2", label:"pypi" },
  { id:"c3", label:"SingularityCE" },
  { id:"c3", label:"Nix" },
  { id:"c3", label:"Docker" },
  { id:"c3", label:"Apptainer" },
  { id:"d1", label:"resqui" },
  { id:"e1", label:"resqui" },
  { id:"e2", label:"mkDocs" },
  { id:"e3", label:"tox" },
  { id:"e3", label:"Jupyter" },
  { id:"f1", label:"resqui" },
  { id:"f1", label:"Checkstyle" },
  { id:"f1", label:"Hadolint" },
  { id:"f1", label:"valgrind" },
  { id:"f1", label:"pre-commit" },
  { id:"f1", label:"gcov" },
  { id:"f1", label:"ruff" },
  { id:"f1", label:"Qlty" },
  { id:"f1", label:"doxygen" },
  { id:"f1", label:"pytest" },
  { id:"f1", label:"flake8" },
  { id:"f1", label:"pylint" },
  { id:"f2", label:"poetry" },
  { id:"f2", label:"black" },
  { id:"f2", label:"pypi" },
  { id:"f2", label:"CppUnit" },
  { id:"f3", label:"sphinx" },
  { id:"f3", label:"cmake" },
  { id:"f3", label:"Hermes Workflows" },
  { id:"f3", label:"Kubernetes" },
  { id:"f3", label:"Jupyter" },
  { id:"f3", label:"Jenkins" },
  { id:"f3", label:"GNU Guix" },
  { id:"f3", label:"tox" },
  { id:"f3", label:"Travis CI" },
  { id:"f3", label:"javadoc" },
  { id:"f3", label:"Junit" },
  { id:"f3", label:"SonarQube" },
  { id:"f3", label:"Git" },
  { id:"f3", label:"SCANOSS" },
  { id:"f3", label:"Dependabot" },
  { id:"g1", label:"resqui" },
  { id:"g1", label:"valgrind" },
  { id:"g1", label:"score-p" },
  { id:"h1", label:"resqui" },
  { id:"h1", label:"valgrind" },
  { id:"h1", label:"pytest" },
  { id:"h2", label:"CppUnit" },
  { id:"h2", label:"Github Actions" },
  { id:"h3", label:"JUnit" },
  { id:"h3", label:"tox" },
  { id:"h3", label:"Docker" },
  { id:"h3", label:"GNU Guix" },
  { id:"h3", label:"Gitlab CICD" },
  { id:"h3", label:"Jenkins" },
  { id:"h3", label:"SonarQube" },
  { id:"h3", label:"Kubernetes" },
  { id:"h3", label:"Apptainer" },
  { id:"h3", label:"Travis CI" },
  { id:"h3", label:"Nix" },
  { id:"i1", label:"resqui" },
  { id:"j1", label:"resqui" },
  { id:"j1", label:"bandit" },
  { id:"j1", label:"Gitleaks" },
  { id:"j1", label:"Hadolint" },
  { id:"j1", label:"bearer" },
  { id:"j3", label:"SonarQube" },
  { id:"j3", label:"SCANOSS" },
  { id:"j3", label:"Nix" },
  { id:"j3", label:"Dependabot" },
  { id:"k1", label:"resqui" },
  { id:"k1", label:"Github Copilot" },
  { id:"k1", label:"Choose a License" },
  { id:"k1", label:"pre-commit" },
  { id:"k1", label:"Gitleaks" },
  { id:"k1", label:"gcov" },
  { id:"k1", label:"valgrind" },
  { id:"k2", label:"Zenodo github Integration" },
  { id:"k2", label:"Github Actions" },
  { id:"k2", label:"poetry" },
  { id:"k3", label:"GNU Guix" },
  { id:"k3", label:"Docker" },
  { id:"k3", label:"zenodo" },
  { id:"k3", label:"javadoc" },
  { id:"k3", label:"Gitlab CICD" },
  { id:"k3", label:"DVC" },
  { id:"k3", label:"Apptainer" },
  { id:"k3", label:"tox" },
  { id:"k3", label:"Software Heritage" },
  { id:"k3", label:"Kubertnetes" },
  { id:"k3", label:"Hermes Workflows" }
];


const W = 1000;
const H = 900;

const CONFIG = {
  segments: segment_labels.length,  // 7,
  rings: ring_labels.length, // 3,
  radius: 400 // Default initial value, gets overwritten below
};

const padding = 40;
const radius = Math.min(W,H)/2 - padding;
CONFIG.radius = radius;



/* =======================
   SVG helpers
======================= */

const NS = "http://www.w3.org/2000/svg";

function el(tag, attrs={}, children=[]) {
  const n = document.createElementNS(NS, tag);
  for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, v);
  for (const c of children) n.append(c);
  return n;
}

function polar(cx, cy, r, a) {
  return { x: cx + r*Math.cos(a), y: cy + r*Math.sin(a) };
}

function sectorPath(cx, cy, r0, r1, a0, a1) {
  const p0 = polar(cx,cy,r1,a0);
  const p1 = polar(cx,cy,r1,a1);
  const p2 = polar(cx,cy,r0,a1);
  const p3 = polar(cx,cy,r0,a0);
  const large = (a1-a0) > Math.PI ? 1 : 0;

  return `
    M ${p0.x} ${p0.y}
    A ${r1} ${r1} 0 ${large} 1 ${p1.x} ${p1.y}
    L ${p2.x} ${p2.y}
    A ${r0} ${r0} 0 ${large} 0 ${p3.x} ${p3.y}
    Z
  `;
}

function hsvToCssHsl(hDeg, sPct, vPct) {

  let h = hDeg / 360;
  let s = sPct / 100;
  let v = vPct / 100;

  let l = (2 - s) * v / 2;

  if (l !== 0) {
    if (l === 1) {
      s = 0;
    } else if (l < 0.5) {
      s = s * v / (l * 2);
    } else {
      s = s * v / (2 - l * 2);
    }
  }

  // ---- clamp to SVG-safe range ----
  s = Math.max(0, Math.min(1, s));
  l = Math.max(0, Math.min(1, l));

  return `hsl(${hDeg}, ${s*100}%, ${l*100}%)`;
}

function ringS(ringIndex, rings) {
  if (rings <= 1) return max_S;
  return ((max_S - min_S) / (rings - 1)) * ((rings - 1) - ringIndex) + min_S;
}

function ringMidRadius(r, rings, maxR) {
  const r0 = maxR * (r / rings);
  const r1 = maxR * ((r+1) / rings);
  return (r0 + r1) / 2;
}

function createChunkGradient(defs, seg, ring, hueDeg, sThis, sNext, r0, r1, reverse=false) {

  const cThis = hsvToCssHsl(hueDeg, sThis, 100);
  const cNext = hsvToCssHsl(hueDeg, sNext, 100);

  const grad = el("radialGradient", {
    id: `chunkGrad-${seg}-${ring}`,
    gradientUnits: "userSpaceOnUse",

    cx: cx,
    cy: cy,
    r: r1,

    fx: cx,
    fy: cy,
    fr: r0
  });


  const c0 = reverse ? cNext : cThis;
  const c1 = reverse ? cThis : cNext;

  grad.append(
    el("stop", { offset: "0%",   "stop-color": c0 }),
    el("stop", { offset: "100%", "stop-color": c1 })
  );

  defs.append(grad);

}

/* =======================
   Random dot placement
======================= */

function randomInCell(id) {
  const g = cellGeometry[id];

  const angle = g.a0 + Math.random()*(g.a1-g.a0);
  const radius = Math.sqrt(Math.random())*(g.r1-g.r0)+g.r0;

  return polar(cx,cy,radius,angle);
}

function drawRingLabels(svg, labels) {

  const rings = labels.length;

  for (let r=0; r<rings; r++) {

    const radius = ringMidRadius(r, rings, CONFIG.radius);

    // left side (mirrored order)
    const left = polar(cx, cy, radius, Math.PI);
    svg.append(
      el("text",{
        x:left.x,
        y:left.y,
        "text-anchor":"middle",
        "dominant-baseline":"middle",
        class:"ring-label"
      // },[labels[rings-1-r]])
      },[labels[r]])
    );

    // right side
    const right = polar(cx, cy, radius, 0);
    svg.append(
      el("text",{
        x:right.x,
        y:right.y,
        "text-anchor":"middle",
        "dominant-baseline":"middle",
        class:"ring-label"
      },[labels[r]])
    );
  }
}

function drawSegmentLabels(svg, labels) {

  const segments = labels.length;
  const labelRadius = CONFIG.radius + 28;

  for (let s=0; s<segments; s++) {

    const angle = ((s + 0.5)/segments)*2*Math.PI - Math.PI/2;
    const p = polar(cx, cy, labelRadius, angle);

    svg.append(
      el("text",{
        x:p.x,
        y:p.y,
        "text-anchor":"middle",
        "dominant-baseline":"middle",
        class:"segment-label"
      },[labels[s]])
    );
  }
}

function outerArcPath(cx, cy, r, a0, a1) {
  const p0 = polar(cx, cy, r, a0);
  const p1 = polar(cx, cy, r, a1);
  const large = (a1-a0) > Math.PI ? 1 : 0;

  return `M ${p0.x} ${p0.y}
          A ${r} ${r} 0 ${large} 1 ${p1.x} ${p1.y}`;
}

function gridToPolar(cell, gx, gy, N) {
  const u = (gx + 0.5)/N;
  const v = (gy + 0.5)/N;

  const angle  = cell.a0 + u*(cell.a1-cell.a0);
  const radius = cell.r0 + v*(cell.r1-cell.r0);

  return polar(cx, cy, radius, angle);
}

function hashString(str) {
  // FNV-1a based hash
  let h = 2166136261;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h,16777619);
  }
  return h>>>0;
}

function placeInCell(cellId, item) {
  if (!occupancy[cellId])
    occupancy[cellId] = new Map();

  let h = hashString(item.label);

  for (let attempt=0; attempt<GRID*GRID; attempt++) {

    const x = h % GRID;
    const y = Math.floor(h / GRID) % GRID;
    const key = `${x},${y}`;

    if (!occupancy[cellId].has(key)) {
      occupancy[cellId].set(key, item);
      return gridToPolar(cellGeometry[cellId], x, y, GRID);
    }

    h = (h*1664525 + 1013904223) >>> 0;
  }

  return null; // cell full
}

function addItem({id,label}) {
  if (!cellGeometry[id]) return;

  const p = placeInCell(id,{id,label});
  if (!p) return;

  svg.append(
    el("circle",{cx:p.x,cy:p.y,r:6,class:"dot"}),
    el("text",{x:p.x+10,y:p.y+4,class:"dot-label"},[label])
  );
}

const GRID = 7;
const occupancy = {};  // id -> Set("x,y")


// ===================================================================================================
//
// ACTUAL CODE STARTS HERE
//
// ===================================================================================================

const min_S = 15;
const max_S = 60;
const cx = W/2;
const cy = H/2;

/* =======================
   Map build
  ======================= */

const svg = el("svg", { viewBox:`0 0 ${W} ${H}` });
document.getElementById("container").append(svg);

const letters = "abcdefghijklmnopqrstuvwxyz";

const defs = el("defs");
svg.append(defs);

const board = el("g",{});
svg.append(board);

const uiLayer = el("g",{class:"ui"});
svg.append(uiLayer);

const hintText = el("text",{
  class:"hint-label",
  "text-anchor":"end",
  "dominant-baseline":"hanging"
});

uiLayer.append(hintText);

function placeHint() {
  hintText.setAttribute("x", W - 16);
  hintText.setAttribute("y", 16);
}

placeHint();

function updateHint() {
  hintText.textContent =
    document.body.classList.contains("map-expanded")
      ? "escape to exit"
      : "click outside circle to zoom";
}

updateHint();

const observer = new MutationObserver(updateHint);

observer.observe(document.body, {
  attributes: true,
  attributeFilter: ["class"]
});

requestAnimationFrame(updateHint);


/* store geometry for later dot placement */
const cellGeometry = {};

for (let s=0; s<CONFIG.segments; s++) {

  const hue = (s/CONFIG.segments)*360;

  for (let r=0; r<CONFIG.rings; r++) {
      const a0 = (s/CONFIG.segments)*2*Math.PI - Math.PI/2;
      const a1 = ((s+1)/CONFIG.segments)*2*Math.PI - Math.PI/2;

      const r0 = CONFIG.radius*(r/CONFIG.rings);
      const r1 = CONFIG.radius*((r+1)/CONFIG.rings);

      const id = letters[s]+(r+1);
      const path = sectorPath(cx,cy,r0,r1,a0,a1);

      const reverseForVisibility = true; // Looks prettier

      const sThis = ringS(r, CONFIG.rings);

      const sNext = (r === CONFIG.rings - 1)
        ? 0                                  // white in HSV terms
        : ringS(r + 1, CONFIG.rings);

      createChunkGradient(defs, s, r, hue, sThis, sNext, r0, r1, reverseForVisibility);

      board.append(
        el("path", {
          d: path,
          class: "cell",
          id,
          fill: `url(#chunkGrad-${s}-${r})`
        })
      );
      cellGeometry[id] = {a0,a1,r0,r1};
  }
}

const rimLayer = el("g",{class:"rim"});
board.append(rimLayer);

for (let s=0; s<CONFIG.segments; s++) {

  const hue = (s/CONFIG.segments)*360;

  const a0 = (s/CONFIG.segments)*2*Math.PI - Math.PI/2;
  const a1 = ((s+1)/CONFIG.segments)*2*Math.PI - Math.PI/2;

  rimLayer.append(
    el("path",{
      d: outerArcPath(cx, cy, CONFIG.radius, a0, a1),
      stroke: hsvToCssHsl(hue,100,100),
      "stroke-width": 2,
      fill:"none",
      "stroke-linecap":"round"
    })
  );
}


drawRingLabels(svg, ring_labels);
drawSegmentLabels(svg, segment_labels);

ITEMS.forEach(addItem);

svg.addEventListener("click", (ev) => {

  const rect = svg.getBoundingClientRect();

  // mouse position in SVG coordinates
  const x = (ev.clientX - rect.left) * (W / rect.width);
  const y = (ev.clientY - rect.top)  * (H / rect.height);

  const dx = x - cx;
  const dy = y - cy;
  const dist = Math.sqrt(dx*dx + dy*dy);

  const clickedOutsideCircle = dist > CONFIG.radius;

  if (clickedOutsideCircle) {
    document.body.classList.toggle("map-expanded");
  }
});

window.addEventListener("keydown", e=>{
  if(e.key==="Escape") {
    document.body.classList.remove("map-expanded");
    updateHint();
  }
});


</script>
</body>
</html>

